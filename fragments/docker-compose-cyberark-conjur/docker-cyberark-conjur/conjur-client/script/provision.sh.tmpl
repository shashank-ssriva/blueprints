#!/usr/bin/env bash

if [ ! -f admin_info/00100-xl_data ]
then
    conjur init -u conjur -a {{ .DockerCyberarkAccount }}
    TOKEN_LINE="$(tail -1 admin_info/admin_data)"
    ADMIN_TOKEN="$(cut -d':' -f2 <<< $TOKEN_LINE)"
    conjur authn login -u admin -p $ADMIN_TOKEN
    conjur policy load --replace root policy/00100-policy.yaml > admin_info/00100-policy

    chmod -R 777 admin_info

    {{- $splitKeys := splitList "," .DockerCyberarkKeys }}
    {{- $policyPath := .DockerCyberarkPolicyPath }}
    {{- range $splitKeys }}
    conjur variable values add {{$policyPath}}/{{ . | trim }} "YOUR_VALUE_HERE"
    {{- end }}

    conjur user update_password --password admin
fi
